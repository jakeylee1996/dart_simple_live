name: Android Release APK (Flutter)

on:
  workflow_dispatch:
    inputs:
      app_path:
        description: "Flutter 应用目录（相对仓库根目录）"
        required: true
        default: "simple_live_app"
      split_per_abi:
        description: "按 ABI 拆分 APK（arm64/armeabi-v7a/x86_64）"
        type: boolean
        required: true
        default: true

permissions:
  contents: read

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-22.04

    env:
      # Flutter 版本锁定到 3.22.x，避免因新版破坏性变更导致构建失败
      FLUTTER_VERSION: "3.22.x"
      ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
      JAVA_DISTRIBUTION: "temurin"
      JAVA_VERSION: "17"
      # 缓存 key 相关
      PUB_CACHE_PATH: "~/.pub-cache"
      GRADLE_CACHE_PATH: "~/.gradle/caches"
      GRADLE_WRAPPER_PATH: "~/.gradle/wrapper"

    steps:
      - name: Checkout
      # 如果你有 Git Submodule，这里可以加上 submodules: true
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install required Android components
        shell: bash
        run: |
          set -eux
          sdkmanager --version
          yes | sdkmanager --licenses >/dev/null
          # 安装常见构建所需组件；如项目固定其他版本，请在此调整
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" >/dev/null

      - name: Set up Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      - name: Show Flutter & Dart versions
        run: |
          flutter --version
          dart --version
          flutter doctor -v

      # ---------------- CACHES ----------------
      - name: Cache Pub (Flutter/Dart packages)
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE_PATH }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.GRADLE_CACHE_PATH }}
            ${{ env.GRADLE_WRAPPER_PATH }}
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # --------------- DEPENDENCIES ---------------
      - name: Flutter pub get
        working-directory: ${{ github.workspace }}/${{ inputs.app_path }}
        run: flutter pub get

      # --------------- SIGNING (两种方式：优先使用Secrets；否则生成临时签名) ---------------
      - name: Use keystore from GitHub Secrets (if provided)
        id: keystore_from_secret
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -eux
          APP_DIR="${{ github.workspace }}/${{ inputs.app_path }}"
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ] && [ -n "${ANDROID_KEYSTORE_PASSWORD:-}" ] \
             && [ -n "${ANDROID_KEY_ALIAS:-}" ] && [ -n "${ANDROID_KEY_PASSWORD:-}" ]; then
            echo "Secrets provided -> configuring release keystore"
            KEYPATH="$HOME/simplelive-keystore.jks"
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$KEYPATH"
            {
              echo "storePassword=${ANDROID_KEYSTORE_PASSWORD}"
              echo "keyPassword=${ANDROID_KEY_PASSWORD}"
              echo "keyAlias=${ANDROID_KEY_ALIAS}"
              echo "storeFile=$KEYPATH"
            } > "$APP_DIR/android/key.properties"
            echo "has_keystore=true" >> $GITHUB_OUTPUT
          else
            echo "Secrets not provided."
            echo "has_keystore=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate temporary keystore (fallback)
        if: steps.keystore_from_secret.outputs.has_keystore == 'false'
        shell: bash
        run: |
          set -eux
          APP_DIR="${{ github.workspace }}/${{ inputs.app_path }}"
          KEYPATH="$HOME/simplelive-temp.jks"
          keytool -genkey -v \
            -keystore "$KEYPATH" \
            -storepass 123456 -keypass 123456 \
            -alias upload -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=CI, OU=CI, O=CI, L=CI, S=CI, C=US"
          {
            echo "storePassword=123456"
            echo "keyPassword=123456"
            echo "keyAlias=upload"
            echo "storeFile=$KEYPATH"
          } > "$APP_DIR/android/key.properties"

      # --------------- BUILD ---------------
      - name: Build release APK
        shell: bash
        working-directory: ${{ github.workspace }}/${{ inputs.app_path }}
        env:
          # 可根据项目需求调整内存等参数，提升稳定性
          GRADLE_OPTS: "-Dorg.gradle.jvmargs='-Xmx4g -XX:+UseParallelGC -XX:MaxMetaspaceSize=1g' -Dkotlin.daemon.jvm.options='-Xmx1g'"
        run: |
          set -eux
          flutter clean
          if [ "${{ inputs.split_per_abi }}" = "true" ]; then
            flutter build apk --release --split-per-abi
          else
            flutter build apk --release
          fi
          ls -al build/app/outputs || true

      # --------------- ARTIFACTS ---------------
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/${{ inputs.app_path }}/build/app/outputs/flutter-apk/*.apk
            ${{ github.workspace }}/${{ inputs.app_path }}/build/app/outputs/apk/release/*.apk
          if-no-files-found: warn
